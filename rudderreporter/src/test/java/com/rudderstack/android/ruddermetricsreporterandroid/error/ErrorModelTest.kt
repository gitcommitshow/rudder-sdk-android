/*
 * Creator: Debanjan Chatterjee on 18/09/23, 6:41 pm Last modified: 18/09/23, 6:41 pm
 * Copyright: All rights reserved â’¸ 2023 http://rudderstack.com
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may obtain a
 * copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

package com.rudderstack.android.ruddermetricsreporterandroid.error

import com.google.gson.GsonBuilder
import com.rudderstack.android.ruddermetricsreporterandroid.LibraryMetadata
import com.rudderstack.gsonrudderadapter.GsonAdapter
import com.rudderstack.jacksonrudderadapter.JacksonAdapter
import org.hamcrest.MatcherAssert.assertThat
import org.hamcrest.Matchers.emptyString
import org.hamcrest.Matchers.not
import org.junit.Test

class ErrorModelTest {
    val errorEvents = listOf(
        """
            {"exceptions":[{"errorClass":"java.lang.Exception","message":"Test Error-Mon Sep 18 16:21:36 GMT+05:30 2023","stacktrace":[{"method":"com.rudderstack.android.sample.kotlin.MainActivity.onCreate${"\$"}lambda${"\$"}{'${"\$"}'}5","file":"MainActivity.kt","lineNumber":78},{"method":"com.rudderstack.android.sample.kotlin.MainActivity.${"\$"}r8${"\$"}lambda${"\$"}{'${"\$"}'}0jx5-_ODOzEyJmgtXRqjTRGD--8","file":"MainActivity.kt","lineNumber":0},{"method":"com.rudderstack.android.sample.kotlin.MainActivity${"\$"}{'${"\$"}'}${"\$"}ExternalSyntheticLambda5.onClick","file":"R8${"\$"}{'${"\$"}'}${"\$"}SyntheticClass","lineNumber":0},{"method":"android.view.View.performClick","file":"View.java","lineNumber":7125},{"method":"android.view.View.performClickInternal","file":"View.java","lineNumber":7102},{"method":"android.view.View.access${"\$"}{'${"\$"}'}3500","file":"View.java","lineNumber":801},{"method":"android.view.View${"\$"}PerformClick.run","file":"View.java","lineNumber":27336},{"method":"android.os.Handler.handleCallback","file":"Handler.java","lineNumber":883},{"method":"android.os.Handler.dispatchMessage","file":"Handler.java","lineNumber":100},{"method":"android.os.Looper.loop","file":"Looper.java","lineNumber":214},{"method":"android.app.ActivityThread.main","file":"ActivityThread.java","lineNumber":7356},{"method":"java.lang.reflect.Method.invoke","file":"Method.java","lineNumber":-2},{"method":"com.android.internal.os.RuntimeInit${"\$"}MethodAndArgsCaller.run","file":"RuntimeInit.java","lineNumber":492},{"method":"com.android.internal.os.ZygoteInit.main","file":"ZygoteInit.java","lineNumber":930}],"type":"ANDROID"}],"severity":"WARNING","breadcrumbs":[],"unhandled":false,"projectPackages":["com.example.testapp1mg"],"app":{"id":"com.example.testapp1mg","releaseStage":"development","version":"1.18.0","versionCode":"15"},"device":{"manufacturer":"Google","model":"Android SDK built for x86","osName":"android","osVersion":"10","cpuAbi":"x86","jailbroken":"true","locale":"en_US","totalMemory":"2089177088","runtimeVersions":{"androidApiLevel":"29","osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys"},"freeDisk":"468799488","freeMemory":"1055404032","orientation":"portrait","time":"2023-09-18T10:51:36.971Z"},"metadata":{"app":{"memoryUsage":4830096,"memoryTrimLevel":"None","totalMemory":6782702,"processName":"com.example.testapp1mg","name":"Sample Kotlin","memoryLimit":536870912,"lowMemory":false,"freeMemory":1952606},"device":{"osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys","manufacturer":"Google","locationStatus":"allowed","networkAccess":"wifi","osVersion":"10","fingerprint":"google/sdk_gphone_x86/generic_x86:10/QSR1.210802.001/7603624:userdebug/dev-keys","model":"Android SDK built for x86","dpi":480,"screenResolution":"1776x1080","brand":"google","apiLevel":29,"batteryLevel":1.0,"cpuAbis":["x86"],"charging":false,"tags":"dev-keys","emulator":true,"screenDensity":3.0}}}
        """.trimIndent(),
        """
            {"exceptions":[{"errorClass":"java.lang.Exception","message":"Test Error-Mon Sep 18 16:21:38 GMT+05:30 2023","stacktrace":[{"method":"com.rudderstack.android.sample.kotlin.MainActivity.onCreate${"\$"}lambda${"\$"}{'${"\$"}'}5","file":"MainActivity.kt","lineNumber":78},{"method":"com.rudderstack.android.sample.kotlin.MainActivity.${"\$"}r8${"\$"}lambda${"\$"}{'${"\$"}'}0jx5-_ODOzEyJmgtXRqjTRGD--8","file":"MainActivity.kt","lineNumber":0},{"method":"com.rudderstack.android.sample.kotlin.MainActivity${"\$"}{'${"\$"}'}${"\$"}ExternalSyntheticLambda5.onClick","file":"R8${"\$"}{'${"\$"}'}${"\$"}SyntheticClass","lineNumber":0},{"method":"android.view.View.performClick","file":"View.java","lineNumber":7125},{"method":"android.view.View.performClickInternal","file":"View.java","lineNumber":7102},{"method":"android.view.View.access${"\$"}{'${"\$"}'}3500","file":"View.java","lineNumber":801},{"method":"android.view.View${"\$"}PerformClick.run","file":"View.java","lineNumber":27336},{"method":"android.os.Handler.handleCallback","file":"Handler.java","lineNumber":883},{"method":"android.os.Handler.dispatchMessage","file":"Handler.java","lineNumber":100},{"method":"android.os.Looper.loop","file":"Looper.java","lineNumber":214},{"method":"android.app.ActivityThread.main","file":"ActivityThread.java","lineNumber":7356},{"method":"java.lang.reflect.Method.invoke","file":"Method.java","lineNumber":-2},{"method":"com.android.internal.os.RuntimeInit${"\$"}MethodAndArgsCaller.run","file":"RuntimeInit.java","lineNumber":492},{"method":"com.android.internal.os.ZygoteInit.main","file":"ZygoteInit.java","lineNumber":930}],"type":"ANDROID"}],"severity":"WARNING","breadcrumbs":[{"metadata":{"unhandled":"false","severity":"WARNING","errorClass":"java.lang.Exception","message":"Test Error-Mon Sep 18 16:21:36 GMT+05:30 2023"},"name":"java.lang.Exception","timestampString":"2023-09-18T10:51:36.978Z","type":"ERROR"}],"unhandled":false,"projectPackages":["com.example.testapp1mg"],"app":{"id":"com.example.testapp1mg","releaseStage":"development","version":"1.18.0","versionCode":"15"},"device":{"manufacturer":"Google","model":"Android SDK built for x86","osName":"android","osVersion":"10","cpuAbi":"x86","jailbroken":"true","locale":"en_US","totalMemory":"2089177088","runtimeVersions":{"androidApiLevel":"29","osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys"},"freeDisk":"468799488","freeMemory":"1055043584","orientation":"portrait","time":"2023-09-18T10:51:38.639Z"},"metadata":{"app":{"memoryUsage":5093448,"memoryTrimLevel":"None","totalMemory":6782702,"processName":"com.example.testapp1mg","name":"Sample Kotlin","memoryLimit":536870912,"lowMemory":false,"freeMemory":1689254},"device":{"osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys","manufacturer":"Google","locationStatus":"allowed","networkAccess":"wifi","osVersion":"10","fingerprint":"google/sdk_gphone_x86/generic_x86:10/QSR1.210802.001/7603624:userdebug/dev-keys","model":"Android SDK built for x86","dpi":480,"screenResolution":"1776x1080","brand":"google","apiLevel":29,"batteryLevel":1.0,"cpuAbis":["x86"],"charging":false,"tags":"dev-keys","emulator":true,"screenDensity":3.0}}}
        """.trimIndent(),
        """
            {"exceptions":[{"errorClass":"java.lang.RuntimeException","message":"Test Crash","stacktrace":[{"method":"com.rudderstack.android.sample.kotlin.MainActivity.onCreate${"\$"}lambda${"\$"}{'${"\$"}'}6","file":"MainActivity.kt","lineNumber":85},{"method":"com.rudderstack.android.sample.kotlin.MainActivity.${"\$"}r8${"\$"}lambda${"\$"}g1e0KVxJHyp7Sq8qpyFEYNo92bY","file":"MainActivity.kt","lineNumber":0},{"method":"com.rudderstack.android.sample.kotlin.MainActivity${"\$"}{'${"\$"}'}${"\$"}ExternalSyntheticLambda6.onClick","file":"R8${"\$"}{'${"\$"}'}${"\$"}SyntheticClass","lineNumber":0},{"method":"android.view.View.performClick","file":"View.java","lineNumber":7125},{"method":"android.view.View.performClickInternal","file":"View.java","lineNumber":7102},{"method":"android.view.View.access${"\$"}{'${"\$"}'}3500","file":"View.java","lineNumber":801},{"method":"android.view.View${"\$"}PerformClick.run","file":"View.java","lineNumber":27336},{"method":"android.os.Handler.handleCallback","file":"Handler.java","lineNumber":883},{"method":"android.os.Handler.dispatchMessage","file":"Handler.java","lineNumber":100},{"method":"android.os.Looper.loop","file":"Looper.java","lineNumber":214},{"method":"android.app.ActivityThread.main","file":"ActivityThread.java","lineNumber":7356},{"method":"java.lang.reflect.Method.invoke","file":"Method.java","lineNumber":-2},{"method":"com.android.internal.os.RuntimeInit${"\$"}MethodAndArgsCaller.run","file":"RuntimeInit.java","lineNumber":492},{"method":"com.android.internal.os.ZygoteInit.main","file":"ZygoteInit.java","lineNumber":930}],"type":"ANDROID"}],"severity":"ERROR","breadcrumbs":[{"metadata":{"unhandled":"false","severity":"WARNING","errorClass":"java.lang.Exception","message":"Test Error-Mon Sep 18 16:21:36 GMT+05:30 2023"},"name":"java.lang.Exception","timestampString":"2023-09-18T10:51:36.978Z","type":"ERROR"},{"metadata":{"unhandled":"false","severity":"WARNING","errorClass":"java.lang.Exception","message":"Test Error-Mon Sep 18 16:21:38 GMT+05:30 2023"},"name":"java.lang.Exception","timestampString":"2023-09-18T10:51:38.647Z","type":"ERROR"}],"unhandled":true,"projectPackages":["com.example.testapp1mg"],"app":{"id":"com.example.testapp1mg","releaseStage":"development","version":"1.18.0","versionCode":"15"},"device":{"manufacturer":"Google","model":"Android SDK built for x86","osName":"android","osVersion":"10","cpuAbi":"x86","jailbroken":"true","locale":"en_US","totalMemory":"2089177088","runtimeVersions":{"androidApiLevel":"29","osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys"},"freeDisk":"468791296","freeMemory":"1066504192","orientation":"portrait","time":"2023-09-18T10:51:40.089Z"},"metadata":{"app":{"memoryUsage":5290696,"memoryTrimLevel":"None","totalMemory":6782702,"processName":"com.example.testapp1mg","name":"Sample Kotlin","memoryLimit":536870912,"lowMemory":false,"freeMemory":1492006},"device":{"osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys","manufacturer":"Google","locationStatus":"allowed","networkAccess":"wifi","osVersion":"10","fingerprint":"google/sdk_gphone_x86/generic_x86:10/QSR1.210802.001/7603624:userdebug/dev-keys","model":"Android SDK built for x86","dpi":480,"screenResolution":"1776x1080","brand":"google","apiLevel":29,"batteryLevel":1.0,"cpuAbis":["x86"],"charging":false,"tags":"dev-keys","emulator":true,"screenDensity":3.0}}}
        """.trimIndent(),
        """
            {"exceptions":[{"errorClass":"java.lang.NullPointerException","stacktrace":[{"method":"com.google.gson.internal.${"\$"}Gson${"\$"}Preconditions.checkNotNull","file":"${"\$"}Gson${"\$"}Preconditions.java","lineNumber":39},{"method":"com.google.gson.reflect.TypeToken.\u003cinit\u003e","file":"TypeToken.java","lineNumber":72},{"method":"com.google.gson.reflect.TypeToken.get","file":"TypeToken.java","lineNumber":296},{"method":"com.google.gson.Gson.fromJson","file":"Gson.java","lineNumber":961},{"method":"com.google.gson.Gson.fromJson","file":"Gson.java","lineNumber":928},{"method":"com.google.gson.Gson.fromJson","file":"Gson.java","lineNumber":877},{"method":"com.rudderstack.gsonrudderadapter.GsonAdapter.readJson","file":"GsonAdapter.kt","lineNumber":31},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.error.ErrorModel.toMap","file":"ErrorModel.kt","lineNumber":33},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.internal.DefaultUploadMediator.createRequestMap","file":"DefaultUploadMediator.kt","lineNumber":59},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.internal.DefaultUploadMediator.upload","file":"DefaultUploadMediator.kt","lineNumber":44},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.internal.DefaultSyncer${"\$"}flush${"\$"}{'${"\$"}'}1.invoke","file":"DefaultSyncer.kt","lineNumber":86},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.internal.DefaultSyncer${"\$"}flush${"\$"}{'${"\$"}'}1.invoke","file":"DefaultSyncer.kt","lineNumber":77},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.internal.DefaultReservoir${"\$"}getMetricsAndErrors${"\$"}{'${"\$"}'}1${"\$"}{'${"\$"}'}1.invoke","file":"DefaultReservoir.kt","lineNumber":207},{"method":"com.rudderstack.android.ruddermetricsreporterandroid.internal.DefaultReservoir${"\$"}getMetricsAndErrors${"\$"}{'${"\$"}'}1${"\$"}{'${"\$"}'}1.invoke","file":"DefaultReservoir.kt","lineNumber":206},{"method":"com.rudderstack.android.repository.Dao${"\$"}runGetQuery${"\$"}{'${"\$"}'}1.invoke","file":"Dao.kt","lineNumber":281},{"method":"com.rudderstack.android.repository.Dao${"\$"}runGetQuery${"\$"}{'${"\$"}'}1.invoke","file":"Dao.kt","lineNumber":280},{"method":"com.rudderstack.android.repository.Dao.runTransactionOrDeferToCreation${"\$"}lambda${"\$"}{'${"\$"}'}26${"\$"}lambda${"\$"}{'${"\$"}'}25","file":"Dao.kt","lineNumber":533},{"method":"com.rudderstack.android.repository.Dao.${"\$"}r8${"\$"}lambda${"\$"}p8FNe_rvlOF8LAj8QetoDZD7f2U","file":"Dao.kt","lineNumber":0},{"method":"com.rudderstack.android.repository.Dao${"\$"}{'${"\$"}'}${"\$"}ExternalSyntheticLambda1.run","file":"R8${"\$"}{'${"\$"}'}${"\$"}SyntheticClass","lineNumber":0},{"method":"java.util.concurrent.ThreadPoolExecutor.runWorker","file":"ThreadPoolExecutor.java","lineNumber":1167},{"method":"java.util.concurrent.ThreadPoolExecutor${"\$"}Worker.run","file":"ThreadPoolExecutor.java","lineNumber":641},{"method":"java.lang.Thread.run","file":"Thread.java","lineNumber":919}],"type":"ANDROID"}],"severity":"ERROR","breadcrumbs":[],"unhandled":true,"projectPackages":["com.example.testapp1mg"],"app":{"id":"com.example.testapp1mg","releaseStage":"development","version":"1.18.0","versionCode":"15"},"device":{"manufacturer":"Google","model":"Android SDK built for x86","osName":"android","osVersion":"10","cpuAbi":"x86","jailbroken":"true","locale":"en_US","totalMemory":"2089177088","runtimeVersions":{"androidApiLevel":"29","osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys"},"freeDisk":"483729408","freeMemory":"1168625664","orientation":"portrait","time":"2023-09-18T11:58:43.154Z"},"metadata":{"app":{"memoryUsage":5613392,"memoryTrimLevel":"None","totalMemory":5787501,"processName":"com.example.testapp1mg","name":"Sample Kotlin","memoryLimit":536870912,"lowMemory":false,"freeMemory":174109},"device":{"osBuild":"sdk_gphone_x86-userdebug 10 QSR1.210802.001 7603624 dev-keys","manufacturer":"Google","locationStatus":"allowed","networkAccess":"none","osVersion":"10","fingerprint":"google/sdk_gphone_x86/generic_x86:10/QSR1.210802.001/7603624:userdebug/dev-keys","model":"Android SDK built for x86","dpi":480,"screenResolution":"1776x1080","brand":"google","apiLevel":29,"batteryLevel":1.0,"cpuAbis":["x86"],"charging":false,"tags":"dev-keys","emulator":true,"screenDensity":3.0}}}
        """.trimIndent(),
    )
    private val dummyLibraryMetadata = LibraryMetadata(
        "test_lub",
        "1.x.x",
        "2",
        "dummy_write_key",
    )
    private val jacksonAdapter = JacksonAdapter()
    private val gsonAdapter = GsonAdapter(GsonBuilder().disableHtmlEscaping().create())

    @Test
    fun `error model serialization test`() {
        val errorModel = ErrorModel(dummyLibraryMetadata, errorEvents)
        val errorModelJackson = errorModel.serialize(jacksonAdapter)
        val errorModelGson = errorModel.serialize(gsonAdapter)

        assertThat(errorModelJackson, not(emptyString()))
        assertThat(errorModelGson, not(emptyString()))
    }
}
